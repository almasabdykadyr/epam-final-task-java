# Архитектура Сервиса Управления Библиотекой

## Введение

Для эффективного управления библиотекой предлагается микросервисная архитектура, разделенная на несколько отдельных сервисов: **User Service**, **Book Service**, **Rent Service** и **Notification Service**. Взаимодействие между сервисами осуществляется через систему обмена сообщениями **Apache Kafka**, что обеспечивает высокую масштабируемость и надежность системы.

## Общая Архитектура

Архитектурная диаграмма *(Примечание: Добавьте соответствующую диаграмму)*

1. **User Service**: Управляет пользователями системы.
2. **Book Service**: Управляет информацией о книгах.
3. **Rent Service**: Обрабатывает аренду и возврат книг.
4. **Notification Service**: Отправляет уведомления пользователям.
5. **Apache Kafka**: Обеспечивает обмен сообщениями между сервисами.

## Описание Сервисов

### 1. User Service

**Функции:**
- Регистрация и аутентификация пользователей.
- Управление профилями пользователей.
- Хранение информации о ролях и правах доступа.

**Entities:**
- **User**
   - `id` (UUID)
   - `username` (string)
   - `password` (string, хэшированный)
   - `email` (string)
   - `role` (enum: USER, ADMIN)
   - `created_at` (timestamp)
   - `updated_at` (timestamp)

**API Endpoints:**
- `POST /api/users/register` – Регистрация нового пользователя.
- `POST /api/users/login` – Аутентификация пользователя.
- `GET /api/users/{id}` – Получение информации о пользователе.
- `PUT /api/users/{id}` – Обновление информации о пользователе.
- `DELETE /api/users/{id}` – Удаление пользователя.

### 2. Book Service

**Функции:**
- Управление каталогом книг.
- Хранение информации о доступности книг.

**Entities:**
- **Book**
   - `id` (UUID)
   - `title` (string)
   - `author` (string)
   - `isbn` (string)
   - `published_date` (date)
   - `genre` (string)
   - `available_copies` (integer)
   - `total_copies` (integer)
   - `created_at` (timestamp)
   - `updated_at` (timestamp)

**API Endpoints:**
- `POST /api/books` – Добавление новой книги.
- `GET /api/books` – Получение списка книг с фильтрацией.
- `GET /api/books/{id}` – Получение информации о конкретной книге.
- `PUT /api/books/{id}` – Обновление информации о книге.
- `DELETE /api/books/{id}` – Удаление книги из каталога.

### 3. Rent Service

**Функции:**
- Обработка аренды и возврата книг.
- Управление сроками аренды и штрафами.

**Entities:**
- **Rent**
   - `id` (UUID)
   - `user_id` (UUID)
   - `book_id` (UUID)
   - `rent_date` (timestamp)
   - `due_date` (timestamp)
   - `return_date` (timestamp, nullable)
   - `status` (enum: RENTED, RETURNED, OVERDUE)
   - `created_at` (timestamp)
   - `updated_at` (timestamp)

**API Endpoints:**
- `POST /api/rents` – Создание новой аренды (аренда книги).
- `GET /api/rents` – Получение списка аренд с фильтрацией.
- `GET /api/rents/{id}` – Получение информации о конкретной аренде.
- `PUT /api/rents/{id}/return` – Возврат арендованной книги.
- `DELETE /api/rents/{id}` – Отмена аренды.

### 4. Notification Service

**Функции:**
- Отправка уведомлений пользователям о статусе аренды, напоминаниях и других событиях.

**Entities:**
- **Notification**
   - `id` (UUID)
   - `user_id` (UUID)
   - `type` (enum: RENT_CONFIRMATION, RETURN_REMINDER, OVERDUE_ALERT, etc.)
   - `message` (string)
   - `status` (enum: PENDING, SENT, FAILED)
   - `created_at` (timestamp)
   - `updated_at` (timestamp)

**API Endpoints:**
- `GET /api/notifications` – Получение списка уведомлений для пользователя.
- `GET /api/notifications/{id}` – Получение конкретного уведомления.
- `PUT /api/notifications/{id}` – Обновление статуса уведомления.
- `DELETE /api/notifications/{id}` – Удаление уведомления.

## Взаимодействие через Kafka

### Темы Kafka

1. **user.events**
   - События, связанные с пользователями (регистрация, обновление профиля и т.д.).

2. **book.events**
   - События, связанные с книгами (добавление, обновление, удаление книг).

3. **rent.events**
   - События, связанные с арендой (создание аренды, возврат книги и т.д.).

4. **notification.events**
   - События для отправки уведомлений.

### Примеры Взаимодействия

1. **Создание Аренды:**
   - **Rent Service** создает аренду и публикует событие `rent.events` с деталями аренды.
   - **Book Service** подписывается на `rent.events` и уменьшает `available_copies` книги.
   - **Notification Service** подписывается на `rent.events` и отправляет подтверждение аренды пользователю.

2. **Возврат Книги:**
   - **Rent Service** обновляет аренду и публикует событие `rent.events`.
   - **Book Service** подписывается и увеличивает `available_copies`.
   - **Notification Service** отправляет уведомление о возврате.

3. **Просроченная Аренда:**
   - **Rent Service** проверяет сроки и публикует событие `rent.events` с статусом `OVERDUE`.
   - **Notification Service** отправляет предупреждение пользователю.

## Технологии и Инструменты

- **Язык программирования**: Java, Python, или любой другой, поддерживающий микросервисы.
- **Фреймворки**: Spring Boot (для Java), Django/Flask (для Python) и т.д.
- **Базы данных**: PostgreSQL или другой реляционный/NoSQL по необходимости для каждого сервиса.
- **Apache Kafka**: Для обмена сообщениями между сервисами.
- **API Gateway**: Например, Kong или API Gateway от AWS для управления API.
- **Контейнеризация**: Docker для упаковки сервисов.
- **Оркестрация**: Kubernetes для управления контейнерами.
- **Мониторинг и Логирование**: Prometheus, Grafana, ELK Stack и т.д.

## Дополнительные Компоненты

- **Аутентификация и Авторизация**: Использование OAuth 2.0 или JWT для безопасности API.
- **Документация API**: Swagger/OpenAPI для документирования и тестирования API.
- **Тестирование**: Unit-тесты, интеграционные тесты для обеспечения качества кода.
- **CI/CD**: Автоматизация развертывания и тестирования с использованием Jenkins, GitHub Actions или аналогичных инструментов.

## Пример Рабочего Потока

1. **Регистрация Пользователя:**
   - Пользователь отправляет `POST /api/users/register` в **User Service**.
   - **User Service** создает пользователя и публикует событие в `user.events`.
   - **Notification Service** подписывается и отправляет приветственное письмо.

2. **Добавление Книги:**
   - Администратор отправляет `POST /api/books` в **Book Service**.
   - **Book Service** добавляет книгу и публикует событие в `book.events`.
   - При необходимости другие сервисы могут реагировать на это событие.

3. **Аренда Книги:**
   - Пользователь отправляет `POST /api/rents` в **Rent Service**.
   - **Rent Service** создает аренду, публикует событие в `rent.events`.
   - **Book Service** обновляет количество доступных копий.
   - **Notification Service** отправляет подтверждение аренды.

## Заключение

Предложенная микросервисная архитектура обеспечивает гибкость, масштабируемость и модульность системы управления библиотекой. Использование Apache Kafka для обмена сообщениями между сервисами гарантирует эффективную и надежную коммуникацию, что особенно важно для распределенных систем. Каждый сервис отвечает за свою область ответственности, что упрощает разработку, тестирование и поддержку системы в целом.